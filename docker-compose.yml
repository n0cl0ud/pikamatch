services:
  qwen-vl:
    image: vllm/vllm-openai:v0.15.0
    container_name: qwen-vl
    # No ports exposed — internal only (clip-api talks to it via Docker network)
    environment:
      - HUGGING_FACE_HUB_TOKEN=${HF_TOKEN}
      - LD_LIBRARY_PATH=/lib/x86_64-linux-gnu:/usr/local/cuda/lib64
    volumes:
      - hf_cache:/root/.cache/huggingface
    command:
      - Qwen/Qwen3-VL-8B-Instruct-FP8
      - --quantization
      - fp8
      - --max-model-len
      - "4096"
      - --gpu-memory-utilization
      - "0.90"
      - --max-num-seqs
      - "2"
      - --limit-mm-per-prompt
      - '{"image": 2}'
      - --dtype
      - half
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: 12G
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:v1.16.3
    container_name: qdrant
    # No ports exposed — internal only (clip-api talks to it via Docker network)
    environment:
      - QDRANT__TELEMETRY_DISABLED=true
      - QDRANT__SERVICE__ENABLE_CORS=false
    volumes:
      - qdrant_data:/qdrant/storage
    deploy:
      resources:
        limits:
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/6333'"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  clip-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: clip-api
    ports:
      - "11434:8002"
    environment:
      - VLM_URL=http://qwen-vl:8000
      - QDRANT_URL=http://qdrant:6333
      - CUDA_VISIBLE_DEVICES=0
      - API_KEY=${API_KEY}
    volumes:
      - hf_cache:/home/appuser/.cache/huggingface
      - indexed_pdfs:/app/indexed_pdfs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: 8G
    depends_on:
      qwen-vl:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    restart: unless-stopped

  ui:
    build:
      context: .
      dockerfile: Dockerfile.ui
    container_name: pikamatch-ui
    ports:
      - "1234:8501"
    environment:
      - API_URL=http://clip-api:8002
      - API_KEY=${API_KEY}
    depends_on:
      clip-api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
    restart: unless-stopped

volumes:
  hf_cache:
  qdrant_data:
  indexed_pdfs:
